# Backend Internationalization

This backend now ships with request-aware i18n for API responses and validation errors.

## How it works

- Translations live in `backend/src/config/i18n.ts` (typed as a const map). Keys are derived from the English tree, giving a `TranslationKey` union for type safety.
- Locale detection middleware (`i18nMiddleware`) runs early in the pipeline (after cookies). Detection order: `?lang` query param → `lang` cookie → `x-locale`/`x-lang` headers → `Accept-Language` negotiation → fallback `env.defaultLanguage` (`en`).
- The middleware sets `req.locale`, `req.t`, `res.locals.locale`, and `res.locals.t`. Use `req.t('errors.notAuthenticated')` anywhere after middleware. If unavailable, the error handler falls back to the default translator.
- Errors carry translation keys via `AppError`. The centralized error handler responds with `{ status, key, message, details, code? }`, where `message` is localized and `key` is stable for clients.
- Zod validation messages are keys; the validation middleware returns localized `message` plus the original `key` per issue.

## Adding or updating translations

1. Add the new locale tree under `translations` in `backend/src/config/i18n.ts`. Keep the shape identical to `en` so the `TranslationKey` union stays consistent.
2. Include the locale code in `SUPPORTED_LANGUAGES` (comma-separated) and adjust `DEFAULT_LANGUAGE` if needed.
3. Use keys in code (e.g., `new AuthenticationError('errors.invalidCredentials')`). TypeScript will complain if the key is missing from the translation map.
4. Prefer parameterized strings when needed (e.g., `'errors.limit': 'Too many requests for {{resource}}'`). Supply params via `new AppError('errors.limit', 429, true, undefined, undefined, { resource: 'register' })`.

## Client expectations

- Error responses always include a stable `key` plus a localized `message`. Frontends can rely on the `key` for UX while optionally showing the localized message.
- Locale selection is stateless and safe for clustered deployments; no global mutable state is mutated at runtime.

## Testing tips

- Set `Accept-Language` or `?lang=fr` in integration tests to assert localized messaging if needed.
- The validation middleware uses the request translator; if you bypass app creation, import `i18n.getTranslator('en')` for helpers.
