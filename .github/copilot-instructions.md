## MERN Auth v4 — AI Agent Instructions

- **Architecture**: Backend is Express 5 + TypeScript. Flow: declarative routes → Zod validators → middleware stack → controllers (asyncHandler) → services → centralized errors. JWT access (15m) and refresh (7d) tokens with Redis-backed sessions.
- **Pipeline order**: See [backend/src/index.ts](backend/src/index.ts): helmet (CSP/HSTS) → CORS → HTTPS guard → parsers → cookies → sanitize.middleware → passport → activity.middleware → requestLogger → morgan → generalLimiter → routes → notFoundHandler → errorHandler. Do not reorder.
- **Env & aliases**: Load env only via [backend/src/config/env.ts](backend/src/config/env.ts) (validateEnv). Use TS path aliases (@config/@services/@controllers/@middleware/@models/@utils/@validators); avoid direct process.env reads elsewhere.
- **Auth cookies & tokens**: Controllers issue/clear access/refresh/CSRF cookies; CSRF is double-submit (cookie + header) with rotation and block threshold; refresh requires matching Redis session and stored refresh token.
- **i18n**: [backend/src/config/i18n.ts](backend/src/config/i18n.ts) holds translations and typed keys. [backend/src/middleware/i18n.middleware.ts](backend/src/middleware/i18n.middleware.ts) sets `req.locale` and translators; [backend/src/middleware/errorHandler.ts](backend/src/middleware/errorHandler.ts) translates `messageKey`/`params`. Validation middleware maps Zod issues to translation keys; controllers/services must use keys, not raw strings.
- **Errors**: Throw AppError subclasses from [backend/src/utils/errors.ts](backend/src/utils/errors.ts); handler shapes JSON with code/status/message/details and sets CSRF Retry-After when blocked. Services stay framework-agnostic.
- **Security stack**: Helmet/CSP/HSTS ([backend/src/config/security.ts](backend/src/config/security.ts)), HTTPS in prod (trust proxy), rate limiting via Redis, CSRF double-submit, HTTP-only cookies with env-driven sameSite/secure/maxAge, sanitize before logging.
- **Routes & middleware ordering**: Keep routes declarative. Common chain: limiter → CSRF → validate({ body/query/... }) → auth middleware (access/optional/refresh) → authorize (role/permission) → controller. Google OAuth routes mount only when enabled in [backend/src/config/oauth.ts](backend/src/config/oauth.ts).
- **Controllers**: Located in [backend/src/controllers](backend/src/controllers); assume validated data from validate.middleware (typed via types/express.d.ts); never re-parse schemas. Controllers set/clear cookies and return localized messages using translation keys.
- **Services**: [backend/src/services/auth.service.ts](backend/src/services/auth.service.ts) covers register/login/refresh/logout/forgot/reset/change/verifyEmail, 2FA, Google OAuth upsert, IP history; [backend/src/services/session.service.ts](backend/src/services/session.service.ts) manages Redis `session:{userId}:{sessionId}`; [backend/src/services/token.service.ts](backend/src/services/token.service.ts) issues typed JWTs; [backend/src/services/email.service.ts](backend/src/services/email.service.ts) sends Resend templates.
- **Models**: [backend/src/models/role.model.ts](backend/src/models/role.model.ts) seeds hierarchy user < admin < super-admin. [backend/src/models/user.model.ts](backend/src/models/user.model.ts) uses bcrypt hooks, tracks passwordChangedAt and IP history (cap 10), supports googleId.
- **Validation**: Zod schemas in [backend/src/validators/auth.validators.ts](backend/src/validators/auth.validators.ts); validate.middleware accepts schema maps (body/query/params/headers/cookies) and injects typed data to req.\*. Validation errors become ValidationError with translation keys.
- **Logging**: Structured via Winston in [backend/src/config/logger.ts](backend/src/config/logger.ts); requestLogger adds auth metadata before morgan; logs stored under logs/.
- **Docs & contracts**: CSRF behavior in [docs/frontend-csrf.md](docs/frontend-csrf.md); i18n approach in [docs/i18n.md](docs/i18n.md); roadmap in [ROADMAP.md](ROADMAP.md).
- **Workflows**: Backend scripts: `npm run dev` (tsx watch), `npm run build` (tsconfig.build), `npm start` (dist), `npm run lint`, `npm run format`, `npm run format:check`, `npm run test` (Vitest + supertest). Husky/lint-staged enforce lint + format:check on staged TS.
- **Testing**: Integration tests in [backend/tests/integration](backend/tests/integration); middleware unit tests (CSRF) in [backend/tests/middleware](backend/tests/middleware). Google OAuth tests auto-skip if env vars absent.
- **Frontend contract**: Frontend lives in frontend/ (React/Vite/Tailwind/Zustand/i18n). Keep API contracts intact (cookies, CSRF headers, localized error codes/messages).
- **Common pitfalls**: Do not bypass validate.middleware or re-run Zod in controllers; always use translation keys; preserve middleware order; avoid direct env reads; ensure CSRF Retry-After header when blocking; keep sanitize.middleware in-place mutation intact.
